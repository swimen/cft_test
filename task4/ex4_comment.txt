4)
Таблица каталога продуктов
create table catalog (cid number primary key, -- id раздела
 par_cid number references catalog, -- ссылка на родительский раздел
 rname varchar2(400), -- наименование раздела
 rdescr varchar2(4000), -- описание
 rcdate date -- дата создания
 );
Таблица продуктов
create table products (pid number primary key, -- id продукта
 rcid number references catalog, -- ссылка на каталог
 pname varchar2(500), -- наименование продукта
 pdescr varchar2(4000), -- спецификация
 punit number references units, -- единица измерения
 pper number references persons, -- ответственный
 );
Таблица движения продуктов
create table records (rpid number references products, -- продукт
 rdate date, -- дата операции
 incoming varchar2(2) default '1', -- поступление '1', расход '0'
 quantity number, -- количество
 rate number -- цена в рублях
 );

Требуется написать sql запрос для вывода примерно в таком виде

<Наименование раздела каталога уровня1>      || Поступление. Руб. || Расход. Руб
 ...
 <Наименование раздела каталога уровня(K-1)> || Поступление. Руб. || Расход. Руб
  <Наименование раздела каталога уровня(K)>  || Поступление. Руб. || Расход. Руб
    <Наименование Продукта1 этого раздела>   || Поступление. Руб. || Расход. Руб || Поступление. Количество || Расход. Количество || Остаток
    ...
    <Наименование ПродуктаN этого раздела>   || Поступление. Руб. || Расход. Руб || Поступление. Количество || Расход. Количество || Остаток 
  <Наименование раздела каталога уровня(K)>  || Поступление. Руб. || Расход. Руб
    <Наименование Продукта1 этого раздела>   || Поступление. Руб. || Расход. Руб || Поступление. Количество || Расход. Количество || Остаток
    ...
    <Наименование ПродуктаN этого раздела>   || Поступление. Руб. || Расход. Руб || Поступление. Количество || Расход. Количество || Остаток 
<Наименование раздела каталога уровня1>      || Поступление. Руб. || Расход. Руб
 ... и так далее аналогично

! Расчет для разделов должен выполняться в соответствии с иерархией.

==============================================
Решение:
==============================================
Объединяем каталоги и продукты в общую выборку, каталоги включаем дважды для формирования закрывающего тега.

По продуктам сразу насчитываем суммы.

Далее с помощью иерархического запроса формируем готовую структуру.

По полю tag = 'open' определяем стоит ли разворячивать иерархию или это закрывающая запись

(в условии открывающая и закрывающая записи на уровне каталога совпадают, это снижает наглядность выгрузки.
По смыслу вроде xml документ надо сформировать, но под требуемый формат вывода не очень подходит
)


